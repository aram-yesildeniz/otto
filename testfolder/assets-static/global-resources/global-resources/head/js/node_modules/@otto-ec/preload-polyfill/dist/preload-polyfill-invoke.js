var preload_polyfill_invoke = (function () {
  'use strict';

  var PRELOAD_STATE = {
    SUCCESS: "success",
    TRY_WITH_ERROR: "try-with-error",
    ERROR: "error",
    NO_INVOKE: "noinvoke"
  };
  var baseSelector = 'link[rel="preload"]';
  var processScript = function processScript(link, isAsync, resolve) {
    var script = document.createElement("script");
    script.async = isAsync;
    script.onload = resolve;
    script.onerror = resolve;
    script.setAttribute("src", link.href);

    if (link.integrity) {
      script.integrity = link.integrity;
    } // if the preload resource has a crossorigin attribute, the generated script should have one aswell, otherwise we get a different resource
    // see https://bugs.chromium.org/p/chromium/issues/detail?id=678429


    if (link.hasAttribute("crossorigin")) {
      script.setAttribute("crossorigin", link.getAttribute("crossorigin"));
    }

    if (link.insertAdjacentElement) {
      link.insertAdjacentElement("afterend", script);
    } else {
      link.parentNode.appendChild(script);
    }

    return script;
  };

  var activateStylesheet = function activateStylesheet(link) {
    link.setAttribute("rel", "stylesheet");
    link.setAttribute("type", "text/css");
    link.setAttribute("media", "all");
    link.removeAttribute("as");
  };
  var processCss = function processCss(link) {
    if ([].map.call(document.styleSheets, function (stylesheet) {
      // Some Firefox browser sometimes throw an exception 'Error: Permission denied to access property "mediaText"' so we have to catch it here ...
      try {
        return stylesheet.media.mediaText === "all" ? stylesheet.href : null;
      } catch (e) {
        return null;
      }
    }).indexOf(link.href) === -1) {
      if (window.requestAnimationFrame) {
        window.requestAnimationFrame(function () {
          return activateStylesheet(link);
        });
      } else {
        activateStylesheet(link);
      }
    }

    link.removeAttribute("onload");
    return link;
  };

  var checkEs6 = function checkEs6() {
    try {
      new Function("(a = 0) => a");
      return true;
    } catch (e) {
      return false;
    }
  };

  var ES6 = checkEs6();
  /**
   * this skips type="module" for browsers that dont understand es6
   * and skips nomodule for browsers that understand es6
   */

  var skipNonMatchingModules = function skipNonMatchingModules(element) {
    if ((element.getAttribute("as") === "script" || element.getAttribute("as") === "worker") && (element.getAttribute("rel") === "nomodule" || element.hasAttribute("module"))) {
      // check for type="module" / nomodule (load es6 or es5) depending on browser capabilties
      var nm = element.getAttribute("rel") === "nomodule";
      var m = element.hasAttribute("module");

      if (m && !ES6 || nm && ES6) {
        return true;
      }
    }

    return false;
  };
  var getPreloads = function getPreloads(selector) {
    var element = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : document;
    var preloads = element.querySelectorAll(selector);
    var uniquePreloads = [];
    var seenUrls = [];

    for (var i = 0, len = preloads.length; i < len; ++i) {
      var preload = preloads[i];

      if (seenUrls.indexOf(preload.href) === -1) {
        seenUrls.push(preload.href);
        uniquePreloads.push(preload);
      }
    }

    return uniquePreloads;
  };

  var setNonCriticalAsync = true;

  var processLink = function processLink(link, isAsync, resolve) {
    var preloadState = link.getAttribute("data-preloaded");

    if (preloadState === PRELOAD_STATE.NO_INVOKE) {
      resolve({
        isError: false,
        href: link.href,
        preloadState: preloadState
      });
    }

    if (preloadState === PRELOAD_STATE.SUCCESS) {
      processScript(link, isAsync, resolve);
    } else if (preloadState === PRELOAD_STATE.TRY_WITH_ERROR) {
      processScript(link, isAsync, function () {
        return resolve({
          isError: true,
          href: link.href,
          preloadState: preloadState
        });
      });
    } else if (preloadState === PRELOAD_STATE.ERROR) {
      resolve({
        isError: true,
        href: link.href,
        preloadState: preloadState
      });
    } else {
      setTimeout(function () {
        processLink(link, isAsync, resolve);
      }, 10);
    }
  };

  var invokeCriticalLinkResources = function invokeCriticalLinkResources(preloads) {
    var promises = [];

    while (preloads.length) {
      promises.push(new window.Promise(function (resolve) {
        processLink(preloads.shift(), false, resolve);
      }));
    }

    return window.Promise.all(promises);
  };

  var invokeNonCriticalLinkResources = function invokeNonCriticalLinkResources(preloads) {
    var promises = [];

    while (preloads.length) {
      promises.push(new window.Promise(function (resolve) {
        processLink(preloads.shift(), setNonCriticalAsync, resolve);
      }));
    }

    return window.Promise.all(promises);
  };

  var invokePreloads = function invokePreloads() {
    var preloads = getPreloads("link[rel='preload'][as='script']");
    var preload;
    var criticals = [];
    var noncriticals = [];

    while ((preload = preloads.shift()) !== undefined) {
      if (!skipNonMatchingModules(preload)) {
        if (preload.hasAttribute("data-critical") || preload.hasAttribute("critical")) {
          criticals.push(preload);
        } else {
          noncriticals.push(preload);
        }
      }
    }

    setNonCriticalAsync = criticals.length === 0;
    // first comes the criticals
    invokeCriticalLinkResources(criticals).then(function () {
      return invokeNonCriticalLinkResources(noncriticals);
    }).then(function (data) {
      try {
        var errorUrls = data.filter(function (el) {
          return el && !!el.isError && !!el.href && !!el.preloadState;
        }).map(function (el) {
          return "".concat(el.href, ":").concat(el.preloadState);
        }).join();

        if (errorUrls.length > 0 && !!window.AS && !!window.AS.RUM && typeof window.AS.RUM.sendCustomRequest === "function") {
          window.AS.RUM.sendCustomRequest("preloadError", {
            urls: errorUrls
          });
        }
      } catch (e) {}

      document.dispatchEvent(new CustomEvent("AllScriptsExecuted"));
    });
  };

  document.addEventListener("DOMContentLoaded", invokePreloads);
  var invoke = (function (element) {
    var preload;
    var preloads = getPreloads(baseSelector, element);

    while ((preload = preloads.shift()) !== undefined) {
      if (preload.getAttribute("as") === "script") {
        if (!skipNonMatchingModules(preload)) {
          processScript(preload, false);
        }
      } else if (preload.getAttribute("as") === "style") {
        processCss(preload);
      } else ;
    }
  });

  return invoke;

}());
